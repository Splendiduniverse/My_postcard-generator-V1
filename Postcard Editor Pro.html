<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Postcard Editor Pro AI - Flux AI (Full Fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Dancing+Script:wght@400..700&display=swap');
        .font-inter { font-family: 'Inter', sans-serif; }
        .font-playfair { font-family: 'Playfair Display', serif; }
        .font-dancing { font-family: 'Dancing Script', cursive; }

        #postcard-container { width: 100%; max-width: 1000px; margin: 0 auto; position: relative; }
        #postcard-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; transition: all 0.3s ease; }

        .aspect-16-9 { padding-top: 56.25%; }
        .aspect-1-1 { padding-top: 100%; }
        .aspect-3-2 { padding-top: 66.66%; }
        .aspect-2-3 { padding-top: 150%; }
        .aspect-7-5 { padding-top: 71.42%; }
        .aspect-5-7 { padding-top: 140%; }

        .layer-text { user-select: none; cursor: move; }
        .text-shadow-custom { text-shadow: 2px 2px 8px rgba(0,0,0,0.8); }
        .layer-selected { outline: 3px dashed #3B82F6; background: rgba(59,130,246,0.15); border-radius: 8px; }
    </style>
</head>
<body class="bg-gray-100 font-inter p-6">
<div class="max-w-7xl mx-auto grid lg:grid-cols-3 gap-8">
    <!-- Panel ƒëi·ªÅu khi·ªÉn -->
    <div class="bg-white rounded-2xl shadow-2xl p-8 space-y-6">
        <h1 class="text-4xl font-bold text-center text-blue-600">Postcard Editor Pro AI</h1>

        <!-- Tabs -->
        <div class="flex border-b border-gray-300">
            <button onclick="openTab(1)" class="tab-btn px-6 py-3 font-bold border-b-4 border-blue-600 text-blue-600">Layers & AI</button>
            <button onclick="openTab(2)" class="tab-btn px-6 py-3 font-bold text-gray-600">K√≠ch th∆∞·ªõc</button>
            <button onclick="openTab(3)" class="tab-btn px-6 py-3 font-bold text-gray-600">Xu·∫•t file</button>
        </div>

        <!-- Tab 1 -->
        <div id="tab1" class="space-y-6">
            <div class="grid grid-cols-3 gap-3 text-xs">
                <button onclick="selectLayer(2)" class="py-3 rounded-lg bg-blue-100 text-blue-800 font-bold">L2 Ti√™u ƒë·ªÅ</button>
                <button onclick="selectLayer(3)" class="py-3 rounded-lg bg-gray-100 hover:bg-gray-200">L3 N·ªôi dung</button>
                <button onclick="selectLayer(4)" class="py-3 rounded-lg bg-gray-100 hover:bg-gray-200">L4 Credit</button>
                <button onclick="selectLayer(5)" class="py-3 rounded-lg bg-gray-100 hover:bg-gray-200">L5 Ph·ª• ƒë·ªÅ</button>
                <button onclick="selectLayer(6)" class="py-3 rounded-lg bg-gray-100 hover:bg-gray-200">L6 Ghi ch√∫</button>
                <button onclick="selectLayer(7)" class="py-3 rounded-lg bg-gray-100 hover:bg-gray-200">L7 K√Ω t√™n</button>
            </div>

            <!-- N·ªÅn AI -->
            <div class="p-5 bg-blue-50 rounded-xl space-y-4">
                <h3 class="font-bold text-blue-800">Layer 01 - N·ªÅn (Flux AI)</h3>
                <input type="color" id="bgcolor" value="#1e293b" class="w-full h-10 rounded" onchange="setBgColor(this.value)">
                <textarea id="bg-prompt" class="w-full p-3 border rounded" rows="3" placeholder="V√≠ d·ª•: ho√†ng h√¥n tr√™n bi·ªÉn, tranh s∆°n d·∫ßu, l√£ng m·∫°n..."></textarea>
                <button onclick="generateBg()" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white py-4 rounded-xl font-bold text-lg hover:from-purple-700 hover:to-blue-700 shadow-lg">‚ú® T·∫°o n·ªÅn b·∫±ng Flux AI (si√™u ƒë·∫πp)</button>
            </div>

            <textarea id="textcontent" class="w-full p-4 border rounded text-lg" rows="5" oninput="updateLayerText()"></textarea>

            <div class="grid grid-cols-2 gap-4">
                <select id="fontfam" onchange="setStyle('font-family',this.value)" class="p-3 border rounded">
                    <option value="font-inter">Inter</option>
                    <option value="font-playfair">Playfair Display</option>
                    <option value="font-dancing">Dancing Script</option>
                </select>
                <input type="number" id="fontsize" min="10" max="300" value="48" onchange="setStyle('font-size',this.value+'px')" class="p-3 border rounded">
                <input type="color" id="textcolor" value="#ffffff" onchange="setStyle('color',this.value)" class="h-12">
                <button onclick="toggleBold()" class="py-3 font-bold bg-gray-200 rounded">Bold</button>
                <button onclick="toggleItalic()" class="py-3 italic bg-gray-200 rounded">Italic</button>
                <button onclick="toggleShadow()" class="py-3 bg-gray-200 rounded col-span-2">Shadow</button>
            </div>

            <div class="grid grid-cols-3 gap-3 text-sm">
                <input type="number" id="posx" min="0" max="100" value="50" oninput="updatePos()" class="p-2 border text-center"><label>X %</label>
                <input type="number" id="posy" min="0" max="100" value="50" oninput="updatePos()" class="p-2 border text-center"><label>Y %</label>
                <input type="number" id="rotate" min="-180" max="180" value="0" oninput="updatePos()" class="p-2 border text-center"><label>Rotate ¬∞</label>
            </div>
        </div>

        <!-- Tab 2: K√≠ch th∆∞·ªõc -->
        <div id="tab2" class="hidden space-y-6">
            <h3 class="text-2xl font-bold">T·ª∑ l·ªá khung h√¨nh</h3>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="setRatio('16-9')" class="ratio-btn py-5 rounded-xl border-4 border-blue-600 bg-blue-50 font-bold text-lg">16:9 Ngang</button>
                <button onclick="setRatio('1-1')" class="ratio-btn py-5 rounded-xl border-2 border-gray-300 hover:border-blue-600">1:1 Vu√¥ng</button>
                <button onclick="setRatio('3-2')" class="ratio-btn py-5 rounded-xl border-2 border-gray-300 hover:border-blue-600">3:2</button>
                <button onclick="setRatio('2-3')" class="ratio-btn py-5 rounded-xl border-2 border-gray-300 hover:border-blue-600">2:3 D·ªçc</button>
                <button onclick="setRatio('7-5')" class="ratio-btn py-5 rounded-xl border-2 border-gray-300 hover:border-blue-600">7:5</button>
                <button onclick="setRatio('5-7')" class="ratio-btn py-5 rounded-xl border-2 border-gray-300 hover:border-blue-600">5:7 D·ªçc</button>
            </div>
        </div>

        <!-- Tab 3 -->
        <div id="tab3" class="hidden space-y-6">
            <button onclick="exportPNG()" class="w-full bg-pink-600 text-white py-5 rounded-xl text-2xl font-bold shadow-lg">T·∫£i PNG</button>
            <button onclick="exportJPG()" class="w-full bg-rose-600 text-white py-5 rounded-xl text-2xl font-bold shadow-lg">T·∫£i JPG</button>
        </div>
    </div>

    <!-- Canvas -->
    <div class="lg:col-span-2">
        <div id="postcard-container" class="aspect-16-9 relative shadow-2xl rounded-3xl overflow-hidden">
            <div id="postcard-canvas" class="absolute inset-0 bg-slate-900">
                <div id="l2" class="layer-text layer-selected absolute text-white font-playfair text-9xl font-bold text-center" style="top:12%;left:50%;transform:translate(-50%,-50%)">Ti√™u ƒë·ªÅ</div>
                <div id="l3" class="layer-text absolute text-white text-4xl text-center leading-relaxed px-10" style="top:50%;left:50%;transform:translate(-50%,-50%)">Ch√∫c b·∫°n lu√¥n h·∫°nh ph√∫c!</div>
                <div id="l4" class="layer-text absolute text-gray-300 text-sm text-center" style="bottom:5%;left:50%;transform:translateX(-50%)">¬© 2025</div>
                <div id="l5" class="layer-text absolute text-gray-200 text-5xl italic text-center" style="top:28%;left:50%;transform:translate(-50%,-50%)">Ph·ª• ƒë·ªÅ</div>
                <div id="l6" class="layer-text absolute text-gray-400 text-xl text-center" style="top:72%;left:50%;transform:translate(-50%,-50%)">Ghi ch√∫</div>
                <div id="l7" class="layer-text absolute text-white font-dancing text-7xl italic text-right" style="bottom:18%;right:10%">K√Ω t√™n</div>
            </div>
        </div>
    </div>
</div>

<!-- Loading -->
<div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
    <div class="bg-white p-12 rounded-3xl text-center shadow-2xl">
        <div class="animate-spin h-20 w-20 border-8 border-blue-600 rounded-full border-t-transparent mx-auto mb-6"></div>
        <p class="text-3xl font-bold text-blue-600">Flux AI ƒëang v·∫Ω n·ªÅn cho b·∫°n...</p>
    </div>
</div>

<script>
    // === KEY FAL.AI C·ª¶A B·∫†N ƒê√É ƒê∆Ø·ª¢C D√ÅN S·∫¥N ===
    const FAL_KEY = "5995330d-ad6a-42b5-b2b0-1b76633ec706:2e95fa31b1baa7098d47d7eda3f627e5";

    let current = 2;
    const canvas = document.getElementById('postcard-canvas');
    const container = document.getElementById('postcard-container');

    function L(n) { return document.getElementById('l' + n); }

    // Tab
    function openTab(n) {
        ['tab1','tab2','tab3'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById('tab'+n).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach((b,i) => b.classList.toggle('border-blue-600', i===n-1));
        document.querySelectorAll('.tab-btn').forEach((b,i) => b.classList.toggle('text-blue-600', i===n-1));
    }

    // Layer
    function selectLayer(id) {
        document.querySelectorAll('.layer-text').forEach(l => l.classList.remove('layer-selected'));
        L(id).classList.add('layer-selected');
        current = id;
        document.getElementById('textcontent').value = L(id).innerText;
    }

    function updateLayerText() { L(current).innerText = document.getElementById('textcontent').value; }

    function setStyle(prop, val) {
        const el = L(current);
        if (prop === 'font-family') {
            el.className = el.className.replace(/font-\w+/g, '');
            el.classList.add(val);
        } else el.style[prop] = val;
    }

    function toggleBold() { L(current).classList.toggle('font-bold'); }
    function toggleItalic() { L(current).classList.toggle('italic'); }
    function toggleShadow() { L(current).classList.toggle('text-shadow-custom'); }

    function updatePos() {
        const el = L(current);
        el.style.left = document.getElementById('posx').value + '%';
        el.style.top = document.getElementById('posy').value + '%';
        el.style.transform = `translate(-50%,-50%) rotate(${document.getElementById('rotate').value}deg)`;
    }

    function setBgColor(c) {
        canvas.style.backgroundColor = c;
        canvas.style.backgroundImage = 'none';
    }

    // T·ª∑ l·ªá
    function setRatio(r) {
        const map = {'16-9':'56.25%','1-1':'100%','3-2':'66.66%','2-3':'150%','7-5':'71.42%','5-7':'140%'};
        container.style.paddingTop = map[r];
        document.querySelectorAll('.ratio-btn').forEach(b => b.classList.remove('border-blue-600','bg-blue-50'));
        event.target.classList.add('border-blue-600','bg-blue-50');
    }

    // === FLUX AI T·∫†O N·ªÄN (ƒê√É D√ÅN KEY C·ª¶A B·∫†N) ===
    async function generateBg() {
    const prompt = document.getElementById('bg-prompt').value.trim() || "beautiful romantic postcard background";
    document.getElementById('loading').classList.remove('hidden');

    try {
        const res = await fetch("https://api-inference.huggingface.co/models/black-forest-labs/FLUX.1-schnell", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ inputs: prompt + ", postcard background high res" })
        });

        if (!res.ok) throw new Error("Hugging Face busy");

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);

        canvas.style.backgroundImage = `url('${url}')`;
        canvas.style.backgroundSize = "cover";
        alert("T·∫°o n·ªÅn th√†nh c√¥ng b·∫±ng Hugging Face Flux! (Mi·ªÖn ph√≠ vƒ©nh vi·ªÖn üòä)");
    } catch (e) {
        alert("L·ªói t·∫°m th·ªùi ‚Äì th·ª≠ l·∫°i sau 1 ph√∫t (Hugging Face ƒë√¥i khi ƒë√¥ng)");
    } finally {
        document.getElementById('loading').classList.add('hidden');
    }
}

    // Xu·∫•t file
    function exportPNG() {
        document.querySelectorAll('.layer-selected').forEach(e => e.classList.remove('layer-selected'));
        html2canvas(canvas, {scale: 2}).then(c => c.toBlob(b => {
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'postcard.png'; a.click();
        }));
    }
    function exportJPG() {
        html2canvas(canvas, {scale: 2}).then(c => c.toBlob(b => {
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'postcard.jpg'; a.click();
        }, 'image/jpeg', 0.95));
    }

    // Kh·ªüi ƒë·ªông
    openTab(1);
    selectLayer(2);
    setRatio('16-9');
</script>
</body>
</html>